ADE7953 Power Sensor
====================

.. seo::
    :description: Instructions for setting up ADE7953 power sensors
    :image: ade7953.png

The ``ade7953`` sensor platform allows you to use ADE7953 single phase energy metering ICs
(`datasheet <https://www.analog.com/media/en/technical-documentation/data-sheets/ADE7953.pdf>`__)
with ESPHome. These are commonly found in **Shelly 2.5** devices.

This sensor can measure voltage and has two channels for reading current and active power (A & B).

.. note::

    SAFETY HAZARD: Some devices such as Sonoff POWs/Shelly/etc, have the digital GND connected directly to mains voltage so **the GPIOs become LIVE during normal operation**. Our advice is to mark these boards to prevent any use of the dangerous digital pins.

The :ref:`I²C Bus <i2c>` is
required to be set up in your configuration for this sensor to work.

.. code-block:: yaml

    # Example configuration entry
    sensor:
      - platform: ade7953
        irq_pin: GPIO16
        voltage:
          name: ADE7953 Voltage
        current_a:
          name: ADE7953 Current A
        current_b:
          name: ADE7953 Current B
        active_power_a:
          name: ADE7953 Active Power A
        active_power_b:
          name: ADE7953 Active Power B
        update_interval: 60s

Configuration variables:
------------------------

- **address** (*Optional*, int): Manually specify the I²C address of the sensor. Defaults to ``0x38``.
- **irq_pin** (*Optional*, :ref:`config-pin`): The pin connected to the ADE7935 IRQ line (if connected)
- **voltage** (*Optional*): Use the voltage value of the sensor in volt. All options from
  :ref:`Sensor <config-sensor>`.
- **current_a** (*Optional*): Use the current value of the A channel in amperes. All options from
  :ref:`Sensor <config-sensor>`.
- **current_b** (*Optional*): Use the current value of the B channel in amperes. All options from
  :ref:`Sensor <config-sensor>`.
- **active_power_a** (*Optional*): Use the power value of the A channel in watts. All options from
  :ref:`Sensor <config-sensor>`.
- **active_power_b** (*Optional*): Use the power value of the A channel in watts. All options from
  :ref:`Sensor <config-sensor>`.
- **update_interval** (*Optional*, :ref:`config-time`): The interval to check the sensor. Defaults to ``60s``
  ``10s`` will also work fine, lower might give unreliable results.

Use with Shelly 2.5
-------------------

The Shelly 2.5 device contains this sensor for power monitoring. An example config for the Shelly 2.5
is given below.

There are three oddities with the Shelly 2.5:

- First, the A and B channels are mixed up - the chip's A channel is label B on the outside and
  vice versa. Probably to make the PCB easier to manufacture.
- Secondly, the output value active_power_b is inverted, which is not the case for active_power_a.
  This is fixed by using a multiply filter as seen in the config below.
- Lastly, the ADE7953 IRQ line is connected to the GPIO16. The irq_pin MUST be set to GPIO16 to prevent device overheat (>70ºC idling).

Additionally, the device has an ::doc:`NTC temperature sensor <ntc>`.

.. code-block:: yaml

    i2c:
      sda: GPIO12
      scl: GPIO14

    sensor:
      - platform: ade7953
        irq_pin: GPIO16 # Prevent overheating by setting this
        voltage:
          name: "Shelly voltage"
          device_class: voltage
          internal: false
        # On the Shelly 2.5 channels are mixed ch1=B ch2=A
        current_b:
          name: "${channel_1} current"
          internal: true
        current_a:
          name: "${channel_2} current"
          internal: true
        active_power_b:
          name: "${channel_1} power"
          id: power_channel_1
          device_class: power
          state_class: measurement
          filters:
            - multiply: -1 # active_power_b is inverted, so multiply by -1
            - lambda: if (x < 2) return 0; else return x; # return zero if below 2w
        active_power_a:
          name: "${channel_2} power"
          id: power_channel_2
          device_class: power
          state_class: measurement
          filters: # active_power_a is normal, so don't multiply by -1
            - lambda: if (x < 2) return 0; else return x; # return zero if below 2w

See Also
--------

- :ref:`sensor-filters`
- :apiref:`ade7953/ade7953.h`
- :ghedit:`Edit`
